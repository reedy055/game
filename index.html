<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Make it feel like a native app -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0F172A" />
  <title>LifeRPG</title>

  <!-- Manifest (PWA) -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <link rel="apple-touch-icon" href="assets/icon-192.png" />

  <!-- Styles -->
  <link rel="preload" href="styles.css" as="style" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Minimal inline fallback while CSS loads */
    body{background:#0B0F1A;color:#E6E9F2;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0}
  </style>
</head>
<body>
  <div id="app">
    <!-- Optional milestone banner (hidden until triggered in JS) -->
    <div id="banner" class="banner hidden" role="status" aria-live="polite"></div>

    <!-- Header / Hero -->
    <header class="app-header">
      <div class="hero">
        <div class="points">
          <div class="points-label">Points Today</div>
          <div id="statPoints" class="points-value">0</div>
        </div>
        <div class="pills">
          <button class="pill" id="pillStreak" data-nav="statsView" title="View stats">
            <span class="emoji">üî•</span><span id="statStreak">0</span>
          </button>
          <!-- Coins pill is now a button; clicking will open the Shop drawer (wired next) -->
          <button class="pill" id="pillCoins" title="Open Shop">
            <span class="emoji">ü™ô</span><span id="statCoins">0</span>
          </button>
        </div>
        <div class="xpbar"><div id="xpFill" style="width:0%"></div></div>
      </div>
    </header>

    <!-- Main Views -->
    <main class="app-main">

      <!-- HOME -->
      <section id="homeView" class="view active" role="region" aria-label="Home">
        <!-- Daily Challenges (no reroll UI visible; button kept for backward compatibility but hidden) -->
        <div class="card">
          <div class="card-head">
            <h3>Daily Challenges</h3>
            <button id="btnReroll" class="btn ghost small" style="display:none">‚Üª Reroll</button>
          </div>
          <div id="dailyList" class="list three-cards">
            <div class="placeholder">Your 3 challenges will appear here.</div>
          </div>
        </div>

        <!-- Weekly Boss Quest (new; wired in next subsection) -->
        <div class="card" id="bossCard">
          <div class="card-head"><h3>Weekly Boss</h3></div>
          <div class="boss-wrap">
            <canvas id="bossRing" width="220" height="220" aria-label="Weekly boss progress"></canvas>
            <div id="bossGoals" class="boss-goals">
              <div class="placeholder">Set sub-goals in Manage ‚Üí Boss (coming next).</div>
            </div>
          </div>
        </div>

        <!-- Completed Today feed (new UI; will be populated in next subsection) -->
        <div class="card" id="completedCard">
          <div class="card-head"><h3>Completed Today</h3></div>
          <div id="feedToday" class="list">
            <div class="placeholder">When you complete tasks/challenges, they‚Äôll appear here.</div>
          </div>
        </div>

        <!-- (Legacy) Tasks list still present so current app keeps working until JS is updated -->
        <div class="card" id="legacyTasksCard">
          <div class="card-head"><h3>Tasks (legacy view)</h3></div>
          <div id="taskList" class="list">
            <div class="placeholder">Add tasks in Manage ‚Üí Tasks.</div>
          </div>
        </div>

        <!-- (Removed from Home) Shop section is gone; Shop will open from Coins pill -->
      </section>

      <!-- STATS -->
      <section id="statsView" class="view" role="region" aria-label="Stats">
        <div class="grid two">
          <div class="card">
            <div class="card-head">
              <h3>Streak</h3>
            </div>
            <div class="streak-wrap">
              <div class="streak-badge"><span>üî•</span><span id="streakBig">0</span></div>
              <div class="streak-meta">
                <div>Best: <strong id="bestStreak">0</strong></div>
                <div>Completions/week: <strong id="cmpWeek">0</strong></div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-head"><h3>30-Day Points</h3></div>
            <canvas id="bar30" width="600" height="260" aria-label="30 day points bar chart"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-head"><h3>Calendar (90 days)</h3></div>
          <div id="heatmap" class="heatmap" aria-label="calendar heatmap"></div>
        </div>
      </section>

      <!-- MANAGE -->
      <section id="manageView" class="view" role="region" aria-label="Manage">
        <!-- Tasks -->
        <div class="card">
          <div class="card-head">
            <h3>Tasks</h3>
            <button id="btnAddTask" class="btn small">+ Add</button>
          </div>
          <div id="manageTasks" class="list admin">
            <div class="placeholder">No tasks yet. Click ‚Äú+ Add‚Äù.</div>
          </div>
        </div>
        <!-- Challenges -->
        <div class="card">
          <div class="card-head">
            <h3>Challenge Pool</h3>
            <button id="btnAddChallenge" class="btn small">+ Add</button>
          </div>
          <div id="manageChallenges" class="list admin">
            <div class="placeholder">No challenges yet. Click ‚Äú+ Add‚Äù.</div>
          </div>
        </div>
        <!-- Shop -->
        <div class="card">
          <div class="card-head">
            <h3>Shop Items</h3>
            <button id="btnAddShop" class="btn small">+ Add</button>
          </div>
          <div id="manageShop" class="list admin">
            <div class="placeholder">No rewards yet. Click ‚Äú+ Add‚Äù.</div>
          </div>
        </div>
        <!-- Weekly Boss (editor) ‚Äî will be wired in the JS update -->
        <div class="card">
          <div class="card-head">
            <h3>Boss Quest (Weekly)</h3>
            <button id="btnBossTemplate1" class="btn ghost small">Use ‚ÄúMomentum‚Äù Template</button>
            <button id="btnBossTemplate2" class="btn ghost small">Use ‚ÄúSocial‚Äù Template</button>
          </div>
          <div id="manageBoss" class="list admin">
            <div class="placeholder">Define 2‚Äì4 sub-goals and link them to tasks. (Wired next.)</div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="settingsView" class="view" role="region" aria-label="Settings">
        <div class="card">
          <div class="card-head"><h3>Game Settings</h3></div>
          <div class="form">
            <label>Reset hour (0‚Äì23)
              <input id="inpResetHour" type="number" min="0" max="23" value="4">
            </label>
            <label class="row">
              <input id="chkHaptics" type="checkbox" checked>
              <span>Haptics</span>
            </label>
          </div>
        </div>

        <div class="card">
          <div class="card-head"><h3>Data</h3></div>
          <div class="row wrap">
            <button id="btnExport" class="btn ghost">Export JSON</button>
            <label class="file">
              <input id="fileImport" type="file" accept="application/json">
              <span class="btn">Import JSON</span>
            </label>
            <button id="btnWipe" class="btn danger">Wipe All Data</button>
          </div>
        </div>

        <div class="card">
          <div class="card-head"><h3>About</h3></div>
          <p class="muted">LifeRPG ‚Äî offline, private, installable. Built with vanilla JS & IndexedDB. Host: GitHub Pages.</p>
        </div>
      </section>

    </main>

    <!-- Bottom Tab Bar (fixed). Center + is inside the bar (bigger, circular). -->
    <nav class="tabbar" role="tablist">
      <button class="tab active" data-target="homeView" aria-selected="true">Home</button>
      <button class="tab" data-target="statsView">Stats</button>

      <!-- Center "+" (not a tab); opens Quick Add drawer -->
      <button id="tabAdd" class="tab-plus" aria-label="Quick Add">+</button>

      <button class="tab" data-target="manageView">Manage</button>
      <button class="tab" data-target="settingsView">Settings</button>
    </nav>

    <!-- Toast -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <!-- Modal (edit/add forms) -->
    <div id="modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-card">
        <div class="modal-head">
          <h3 id="modalTitle">Modal</h3>
          <button id="modalClose" class="icon-btn" aria-label="Close">‚úï</button>
        </div>
        <div id="modalBody" class="modal-body"></div>
        <div class="modal-actions">
          <button id="modalCancel" class="btn ghost">Cancel</button>
          <button id="modalOk" class="btn">Save</button>
        </div>
      </div>
    </div>

    <!-- Quick Add Drawer (hidden until wired) -->
    <div id="drawerQuickAdd" class="drawer hidden" role="dialog" aria-modal="true" aria-labelledby="qaTitle">
      <div class="drawer-card">
        <div class="drawer-head">
          <h3 id="qaTitle">Quick Add</h3>
          <button id="drawerQuickClose" class="icon-btn" aria-label="Close">‚úï</button>
        </div>
        <div id="quickFavsRow" class="quick-row hidden">
          <div class="quick-title">Favorites</div>
          <div id="quickFavs" class="quick-chips"></div>
        </div>
        <div class="quick-title">All Tasks</div>
        <div id="quickTaskList" class="quick-grid">
          <div class="placeholder">Add tasks in Manage ‚Üí Tasks, then tap +</div>
        </div>
      </div>
    </div>

    <!-- Shop Drawer (from Coins pill) -->
    <div id="drawerShop" class="drawer hidden" role="dialog" aria-modal="true" aria-labelledby="shopTitle">
      <div class="drawer-card">
        <div class="drawer-head">
          <h3 id="shopTitle">Shop</h3>
          <button id="drawerShopClose" class="icon-btn" aria-label="Close">‚úï</button>
        </div>
        <div id="shopDrawerList" class="shop-drawer-list">
          <div class="placeholder">No rewards yet. Add some in Manage ‚Üí Shop.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import "./app.js";
  </script>
  <script>
    // Register SW early (kept)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
    // Fallback tab wiring if app.js hasn't run yet (the center "+" is NOT a tab)
    (function(){
      const tabs = document.querySelectorAll('.tabbar .tab');
      const views = document.querySelectorAll('.view');
      tabs.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          tabs.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const id = btn.getAttribute('data-target');
          views.forEach(v=>v.classList.toggle('active', v.id===id));
          // focus for a11y
          const el = document.getElementById(id);
          if (el) { el.setAttribute('tabindex','-1'); el.focus({preventScroll:true}); }
        });
      });
      // The center "+" will be wired in app.js ‚Äî no-op for now
    })();
  </script>
</body>
</html>
