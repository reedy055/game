<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Disable zoom feel; safe areas for iOS -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0F172A" />
  <title>LifeRPG</title>

  <!-- Manifest (PWA) -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="apple-touch-icon" href="assets/icon-192.png">

  <link rel="preload" href="styles.css" as="style">
  <link rel="stylesheet" href="styles.css">
  <style>
    body{background:#0B0F1A;color:#E6E9F2;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0}
  </style>
</head>
<body>
  <div id="app">
    <!-- Header / Hero -->
    <header class="app-header">
      <div class="hero">
        <div class="points">
          <div class="points-label">Points Today</div>
          <div id="statPoints" class="points-value">0</div>
        </div>
        <div class="pills">
          <button class="pill" id="pillStreak" data-nav="statsView" title="View stats">
            <span class="emoji">üî•</span><span id="statStreak">0</span>
          </button>
          <!-- Coins now opens Shop drawer -->
          <button class="pill" id="pillCoins" title="Open Shop">
            <span class="emoji">ü™ô</span><span id="statCoins">0</span>
          </button>
        </div>
        <div class="xpbar"><div id="xpFill" style="width:0%"></div></div>
      </div>
    </header>

    <main class="app-main">
      <!-- HOME -->
      <section id="homeView" class="view active" role="region" aria-label="Home">
        <!-- Daily Challenges (fixed 3, no reroll) -->
        <div class="card">
          <div class="card-head">
            <h3>Daily Challenges</h3>
          </div>
          <div id="dailyList" class="list three-cards">
            <div class="placeholder">Your 3 challenges will appear here.</div>
          </div>
        </div>

        <!-- Completed Today feed (replaces Tasks list) -->
        <div class="card">
          <div class="card-head">
            <h3>Completed Today</h3>
          </div>
          <div id="completedList" class="list">
            <div class="placeholder">Nothing yet. Tap the + button to add tasks.</div>
          </div>
        </div>
      </section>

      <!-- STATS -->
      <section id="statsView" class="view" role="region" aria-label="Stats">
        <div class="grid two">
          <div class="card">
            <div class="card-head">
              <h3>Streak</h3>
            </div>
            <div class="streak-wrap">
              <div class="streak-badge"><span>üî•</span><span id="streakBig">0</span></div>
              <div class="streak-meta">
                <div>Best: <strong id="bestStreak">0</strong></div>
                <div>Completions/week: <strong id="cmpWeek">0</strong></div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-head"><h3>30-Day Points</h3></div>
            <canvas id="bar30" width="600" height="260" aria-label="30 day points bar chart"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-head"><h3>Calendar (90 days)</h3></div>
          <div id="heatmap" class="heatmap" aria-label="calendar heatmap"></div>
        </div>
      </section>

      <!-- MANAGE -->
      <section id="manageView" class="view" role="region" aria-label="Manage">
        <div class="card">
          <div class="card-head">
            <h3>Tasks</h3>
            <button id="btnAddTask" class="btn small">+ Add</button>
          </div>
          <div id="manageTasks" class="list admin">
            <div class="placeholder">No tasks yet. Click ‚Äú+ Add‚Äù.</div>
          </div>
        </div>
        <div class="card">
          <div class="card-head">
            <h3>Challenge Pool</h3>
            <button id="btnAddChallenge" class="btn small">+ Add</button>
          </div>
          <div id="manageChallenges" class="list admin">
            <div class="placeholder">No challenges yet. Click ‚Äú+ Add‚Äù.</div>
          </div>
        </div>
        <div class="card">
          <div class="card-head">
            <h3>Shop Items</h3>
            <button id="btnAddShop" class="btn small">+ Add</button>
          </div>
          <div id="manageShop" class="list admin">
            <div class="placeholder">No rewards yet. Click ‚Äú+ Add‚Äù.</div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="settingsView" class="view" role="region" aria-label="Settings">
        <div class="card">
          <div class="card-head"><h3>Game Settings</h3></div>
          <div class="form">
            <label>Reset hour (0‚Äì23)
              <input id="inpResetHour" type="number" min="0" max="23" value="4">
            </label>
            <label>Reroll cost (coins)
              <input id="inpRerollCost" type="number" min="0" max="999" value="20">
            </label>
            <label class="row">
              <input id="chkHaptics" type="checkbox" checked>
              <span>Haptics</span>
            </label>
          </div>
        </div>

        <div class="card">
          <div class="card-head"><h3>Data</h3></div>
          <div class="row wrap">
            <button id="btnExport" class="btn ghost">Export JSON</button>
            <label class="file">
              <input id="fileImport" type="file" accept="application/json">
              <span class="btn">Import JSON</span>
            </label>
            <button id="btnWipe" class="btn danger">Wipe All Data</button>
          </div>
        </div>

        <div class="card">
          <div class="card-head"><h3>About</h3></div>
          <p class="muted">LifeRPG ‚Äî offline, private, installable. Built with vanilla JS & IndexedDB. Host: GitHub Pages.</p>
        </div>
      </section>
    </main>

    <!-- Fixed Bottom Tab Bar -->
    <nav class="tabbar" role="tablist">
      <button class="tab active" data-target="homeView" aria-selected="true">Home</button>
      <button class="tab" data-target="statsView">Stats</button>
      <button class="tab" data-target="manageView">Manage</button>
      <button class="tab" data-target="settingsView">Settings</button>
    </nav>

    <!-- Big Center "+" -->
    <button id="fabAdd" class="fab" aria-label="Quick add">Ôºã</button>

    <!-- Toast -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <!-- Edit/Add Modal (Manage) -->
    <div id="modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-card">
        <div class="modal-head">
          <h3 id="modalTitle">Modal</h3>
          <button id="modalClose" class="icon-btn" aria-label="Close">‚úï</button>
        </div>
        <div id="modalBody" class="modal-body"></div>
        <div class="modal-actions">
          <button id="modalCancel" class="btn ghost">Cancel</button>
          <button id="modalOk" class="btn">Save</button>
        </div>
      </div>
    </div>

    <!-- Quick Add Sheet -->
    <div id="qaSheet" class="sheet hidden" aria-modal="true" role="dialog" aria-labelledby="qaTitle">
      <div class="sheet-overlay" data-close="qaSheet"></div>
      <div class="sheet-panel">
        <div class="sheet-head">
          <h3 id="qaTitle">Quick Add</h3>
          <button class="icon-btn" data-close="qaSheet">‚úï</button>
        </div>
        <div id="qaList" class="qa-list">
          <!-- Task pills render here -->
        </div>
      </div>
    </div>

    <!-- Shop Sheet -->
    <div id="shopSheet" class="sheet hidden" aria-modal="true" role="dialog" aria-labelledby="shopTitle">
      <div class="sheet-overlay" data-close="shopSheet"></div>
      <div class="sheet-panel">
        <div class="sheet-head">
          <h3 id="shopTitle">Shop</h3>
          <button class="icon-btn" data-close="shopSheet">‚úï</button>
        </div>
        <div id="shopDrawerList" class="list horizontal">
          <!-- Shop items render here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import "./app.js";
  </script>
  <script>
    // Register SW (kept)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
    // Fallback tab wiring
    (function(){
      const tabs = document.querySelectorAll('.tabbar .tab');
      const views = document.querySelectorAll('.view');
      tabs.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          tabs.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const id = btn.getAttribute('data-target');
          views.forEach(v=>v.classList.toggle('active', v.id===id));
        });
      });
    })();
  </script>
</body>
</html>
